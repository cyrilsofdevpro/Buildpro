<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - BuilPro</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<style>
      .logout-btn {
      position: absolute;
      top: 15px;
      right: 20px;
      background-color: #dc2626;
      color: #fff;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 5px;
    }
    .logout-btn:hover {
      background-color: #b91c1c;
    }
</style>
<body>
  <button id="logoutBtn">Logout</button>
  <div class="form-container">
    <h2>Admin Panel</h2>

    <!-- Messages Section -->
    <section>
      <h3>üì© New Messages</h3>
      <ul id="newMessagesList">Checking for new messages...</ul>
    </section>

    <!-- Freelancer Applications Section -->
    <section>
      <h3>üë∑ Freelancer Applications</h3>
      <ul id="freelancerList">Loading...</ul>
    </section>

    <!-- Design Requests Section -->
    <section>
      <h3>üìÅ Design Requests</h3>
      <ul id="requestList">Loading...</ul>
    </section>
  </div>

  <script type="module">
    import { auth, db } from './js/firebase-config.js';
    import { signOut } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
    import {
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
    import {
      collection,
      getDocs,
      doc,
      updateDoc,
      query,
      orderBy,
      getDoc,
      limit
    } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";

    const adminEmail = "admin@builpro.com"; // Set your admin email here

    const newMessagesList = document.getElementById("newMessagesList");
    const freelancerList = document.getElementById("freelancerList");
    const requestList = document.getElementById("requestList");

    onAuthStateChanged(auth, async (user) => {
      if (!user || user.email !== adminEmail) {
        alert("Access Denied. Admin only.");
        window.location.href = "index.html";
        return;
      }

      const uid = user.uid;

      // Load recent messages
      const chatSnap = await getDocs(collection(db, "chats"));
      newMessagesList.innerHTML = "";

      chatSnap.forEach(async (chatDoc) => {
        const chatId = chatDoc.id;
        const messagesRef = collection(db, "chats", chatId, "messages");
        const recentMsgQuery = query(messagesRef, orderBy("timestamp", "desc"), limit(1));
        const snapshot = await getDocs(recentMsgQuery);

        if (!snapshot.empty) {
          const msg = snapshot.docs[0].data();
          if (msg.sender !== uid) {
            const senderSnap = await getDoc(doc(db, "users", msg.sender));
            const senderName = senderSnap.exists() ? senderSnap.data().fullname : "User";
            const time = msg.timestamp?.toDate().toLocaleString() || "Just now";

            const li = document.createElement("li");
            li.innerHTML = `
              <strong>${senderName}</strong>: ${msg.text}<br>
              <small>${time}</small><br>
              <a href="chat.html?job=${chatId}">üí¨ Reply</a>
            `;
            newMessagesList.appendChild(li);
          }
        }
      });

      document.getElementById("logoutBtn").addEventListener("click", () => {
  signOut(auth).then(() => {
    window.location.href = "index.html";
  });
});

      // Load freelancer applications
      const freelancerSnap = await getDocs(collection(db, "freelancer_applications"));
      const approvedFreelancers = [];
      freelancerList.innerHTML = "";

      freelancerSnap.forEach((docSnap) => {
        const data = docSnap.data();
        const li = document.createElement("li");
        li.innerHTML = `
          <strong>${data.fullname}</strong> ‚Äî ${data.skills}<br>
          <a href="${data.portfolio}" target="_blank">Portfolio</a><br>
          Status: <em>${data.status}</em><br>
          <button data-id="${docSnap.id}" data-type="freelancer" data-action="approved">Approve</button>
          <button data-id="${docSnap.id}" data-type="freelancer" data-action="rejected">Reject</button>
        `;
        freelancerList.appendChild(li);

        if (data.status === "approved") {
          approvedFreelancers.push({ id: data.userId, name: data.fullname });
        }
      });

      // Load design requests
      const requestSnap = await getDocs(collection(db, "design_requests"));
      requestList.innerHTML = "";

      requestSnap.forEach((docSnap) => {
        const data = docSnap.data();
        const li = document.createElement("li");

        let options = `<option value="">Assign Freelancer</option>`;
        approvedFreelancers.forEach(f =>
          options += `<option value="${f.id}|${f.name}">${f.name}</option>`
        );

        li.innerHTML = `
          <strong>${data.projectTitle}</strong> ‚Äî ${data.category}<br>
          Budget: ‚Ç¶${data.budget} | Deadline: ${data.deadline}<br>
          Status: <em>${data.status}</em><br>
          Assigned To: ${data.assignedName || "None"}<br>
          <select data-id="${docSnap.id}" class="assign-dropdown">${options}</select><br><br>
          <button data-id="${docSnap.id}" data-type="request" data-action="approved">Approve</button>
          <button data-id="${docSnap.id}" data-type="request" data-action="rejected">Reject</button>
        `;
        requestList.appendChild(li);
      });
    });

    // Handle approval button clicks
    document.addEventListener("click", async (e) => {
      if (e.target.tagName === "BUTTON" && e.target.dataset.id) {
        const ref = doc(db, e.target.dataset.type === "freelancer" ? "freelancer_applications" : "design_requests", e.target.dataset.id);
        await updateDoc(ref, { status: e.target.dataset.action });
        alert(`Marked as ${e.target.dataset.action}`);
        location.reload();
      }
    });

    // Handle freelancer assignment
    document.addEventListener("change", async (e) => {
      if (e.target.classList.contains("assign-dropdown")) {
        const [freelancerId, freelancerName] = e.target.value.split("|");
        const requestId = e.target.dataset.id;
        if (!freelancerId) return;

        const requestRef = doc(db, "design_requests", requestId);
        await updateDoc(requestRef, {
          assignedTo: freelancerId,
          assignedName: freelancerName
        });

        alert(`Assigned to ${freelancerName}`);
        location.reload();
      }
    });
  </script>
</body>
</html>
