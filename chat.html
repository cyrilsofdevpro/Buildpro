<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BuilPro Chat</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .chat-box {
      border: 1px solid #ccc;
      padding: 1rem;
      height: 400px;
      overflow-y: auto;
      background: #f9f9f9;
      margin-bottom: 1rem;
    }
    .message {
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 5px;
    }
    .own { background: #d1ffd1; text-align: right; }
    .other { background: #eee; }
    form { display: flex; gap: 10px; }
    input[type="text"] { flex: 1; padding: 8px; }
  </style>
</head>
<body>
  <div class="form-container">
    <h2>Chat</h2>
    <div class="chat-box" id="chatBox">Loading...</div>
    <form id="chatForm">
      <input type="text" id="messageInput" placeholder="Type your message..." required />
      <button type="submit">Send</button>
    </form>
    <p><a href="freelancer.html">‚Üê Back</a></p>
  </div>

<script type="module">
  import { auth, db } from './js/firebase-config.js';
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
  import {
    doc, collection, addDoc, serverTimestamp,
    query, orderBy, onSnapshot, getDoc
  } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";

  const params = new URLSearchParams(window.location.search);
  const jobId = params.get("job");

  if (!jobId) {
    alert("No job ID specified.");
    window.location.href = "freelancer.html";
  }

  const messagesRef = collection(db, "chats", jobId, "messages");

  const chatBox = document.querySelector("#chatBox");
  const chatForm = document.querySelector("#chatForm");
  const msgInput = document.querySelector("#messageInput");

  let currentUser = null;

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    currentUser = user;

    const q = query(messagesRef, orderBy("timestamp"));
    onSnapshot(q, async (snapshot) => {
      chatBox.innerHTML = "";
      if (snapshot.empty) {
        chatBox.innerHTML = "<p>No messages yet.</p>";
        return;
      }

      for (const docSnap of snapshot.docs) {
        const msg = docSnap.data();

        // Get sender name
        let senderName = "User";
        try {
          const senderDoc = await getDoc(doc(db, "users", msg.sender));
          if (senderDoc.exists()) {
            senderName = senderDoc.data().fullname || "User";
          }
        } catch (err) {
          console.warn("Could not fetch sender name", err);
        }

        const date = msg.timestamp?.toDate().toLocaleString() || "Just now";
        const alignRight = msg.sender === currentUser.uid;

        const bubble = document.createElement("div");
        bubble.style.textAlign = alignRight ? "right" : "left";
        bubble.innerHTML = `
          <div style="
            display: inline-block;
            background: ${alignRight ? '#007bff' : '#eaeaea'};
            color: ${alignRight ? 'white' : 'black'};
            padding: 10px;
            border-radius: 8px;
            max-width: 70%;
            margin: 4px 0;
          ">
            <small><strong>${senderName}</strong></small><br>
            ${msg.text}<br>
            <small style="font-size: 0.75rem; color: ${alignRight ? '#cce' : '#666'}">${date}</small>
          </div>
        `;
        chatBox.appendChild(bubble);
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    });
  });

  chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = msgInput.value.trim();
    if (!text || !currentUser) return;

    await addDoc(messagesRef, {
      sender: currentUser.uid,
      text,
      timestamp: serverTimestamp()
    });

    msgInput.value = "";
  });
</script>

</body>
</html>
