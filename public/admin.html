<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - BuilPro</title>
  <link rel="stylesheet" href="css/styles.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .logout-btn {
      position: absolute;
      top: 15px;
      right: 20px;
      background-color: #dc2626;
      color: #fff;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 5px;
    }
    .logout-btn:hover {
      background-color: #b91c1c;
    }
    .btn-sm {
      font-size: 0.8rem;
      padding: 4px 8px;
      margin-left: 5px;
      border-radius: 3px;
    }
    .btn-ship {
      background-color: #3b82f6;
      color: white;
    }
    .btn-ship:hover {
      background-color: #2563eb;
    }
  </style>
</head>
<body>
  <button id="logoutBtn" class="logout-btn">Logout</button>

  <div class="form-container p-6 max-w-4xl mx-auto">
    <h2 class="text-2xl font-bold mb-4">Admin Panel</h2>

    <!-- Messages -->
    <section class="mb-6">
      <h3 class="text-xl font-semibold mb-2">üì© New Messages</h3>
      <ul id="newMessagesList">Checking for new messages...</ul>
    </section>

    <!-- Freelancer Applications -->
    <section class="mb-6">
      <h3 class="text-xl font-semibold mb-2">üíº Freelancer Applications</h3>
      <ul id="freelancerList">Loading...</ul>
    </section>

    <!-- Design Requests -->
    <section class="mb-6">
      <h3 class="text-xl font-semibold mb-2">üìÅ Design Requests</h3>
      <ul id="requestList">Loading...</ul>
    </section>

    <!-- Orders -->
    <section class="mb-6">
      <h3 class="text-xl font-semibold mb-2">üí∞ Marketplace Orders</h3>
      <ul id="ordersList">Loading orders...</ul>
    </section>

    <!-- Product Posting -->
    <section class="mb-6">
      <h3 class="text-xl font-semibold mb-2">üì¶ Post New Product</h3>
      <form id="productForm" class="space-y-2">
        <input type="text" id="prodName" placeholder="Product Name" class="p-2 border rounded w-full" required />
        <input type="text" id="prodCategory" placeholder="Category (e.g. Cement)" class="p-2 border rounded w-full" required />
        <input type="number" id="prodPrice" placeholder="Price" class="p-2 border rounded w-full" required />
        <textarea id="prodDescription" placeholder="Description" class="p-2 border rounded w-full" required></textarea>
        <input type="text" id="prodImage" placeholder="Image URL" class="p-2 border rounded w-full" required />
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Add Product</button>
        <p id="prodMsg" class="text-green-600 mt-2"></p>
      </form>
    </section>
  </div>

  <script type="module">
    import { auth, db } from './js/firebase-config.js';
    import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
    import {
      collection, getDocs, doc, updateDoc, getDoc,
      query, orderBy, limit, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";

    const adminEmail = "admin@builpro.com";
    const newMessagesList = document.getElementById("newMessagesList");
    const freelancerList = document.getElementById("freelancerList");
    const requestList = document.getElementById("requestList");
    const ordersList = document.getElementById("ordersList");

    onAuthStateChanged(auth, async (user) => {
      if (!user || user.email !== adminEmail) {
        alert("Access Denied. Admin only.");
        window.location.href = "index.html";
        return;
      }

      const uid = user.uid;

      // Load messages
      const chatSnap = await getDocs(collection(db, "chats"));
      newMessagesList.innerHTML = "";
      chatSnap.forEach(async (chatDoc) => {
        const chatId = chatDoc.id;
        const messagesRef = collection(db, "chats", chatId, "messages");
        const recentMsgQuery = query(messagesRef, orderBy("timestamp", "desc"), limit(1));
        const snapshot = await getDocs(recentMsgQuery);

        if (!snapshot.empty) {
          const msg = snapshot.docs[0].data();
          if (msg.sender !== uid) {
            const senderSnap = await getDoc(doc(db, "users", msg.sender));
            const senderName = senderSnap.exists() ? senderSnap.data().fullname : "User";
            const time = msg.timestamp?.toDate().toLocaleString() || "Just now";

            const li = document.createElement("li");
            li.innerHTML = `
              <strong>${senderName}</strong>: ${msg.text}<br>
              <small>${time}</small><br>
              <a href="chat.html?job=${chatId}">üí¨ Reply</a>
            `;
            newMessagesList.appendChild(li);
          }
        }
      });

      document.getElementById("logoutBtn").addEventListener("click", () => {
        signOut(auth).then(() => {
          window.location.href = "index.html";
        });
      });

      // Load freelancer applications
      const freelancerSnap = await getDocs(collection(db, "freelancer_applications"));
      const approvedFreelancers = [];
      freelancerList.innerHTML = "";

      freelancerSnap.forEach((docSnap) => {
        const data = docSnap.data();
        const li = document.createElement("li");
        li.innerHTML = `
          <strong>${data.fullname}</strong> ‚Äî ${data.skills}<br>
          <a href="${data.portfolio}" target="_blank">Portfolio</a><br>
          Status: <em>${data.status}</em><br>
          <button data-id="${docSnap.id}" data-type="freelancer" data-action="approved">Approve</button>
          <button data-id="${docSnap.id}" data-type="freelancer" data-action="rejected">Reject</button>
        `;
        freelancerList.appendChild(li);
        if (data.status === "approved") {
          approvedFreelancers.push({ id: data.userId, name: data.fullname });
        }
      });

      // Load design requests
      const requestSnap = await getDocs(collection(db, "design_requests"));
      requestList.innerHTML = "";

      requestSnap.forEach((docSnap) => {
        const data = docSnap.data();
        const li = document.createElement("li");

        let options = `<option value="">Assign Freelancer</option>`;
        approvedFreelancers.forEach(f =>
          options += `<option value="${f.id}|${f.name}">${f.name}</option>`
        );

        li.innerHTML = `
          <strong>${data.projectTitle}</strong> ‚Äî ${data.category}<br>
          Budget: ‚Ç¶${data.budget} | Deadline: ${data.deadline}<br>
          Status: <em>${data.status}</em><br>
          Assigned To: ${data.assignedName || "None"}<br>
          <select data-id="${docSnap.id}" class="assign-dropdown">${options}</select><br><br>
          <button data-id="${docSnap.id}" data-type="request" data-action="approved">Approve</button>
          <button data-id="${docSnap.id}" data-type="request" data-action="rejected">Reject</button>
        `;
        requestList.appendChild(li);
      });

      // Load orders
      const ordersSnap = await getDocs(collection(db, "orders"));
      ordersList.innerHTML = "";

      ordersSnap.forEach((orderDoc) => {
        const order = orderDoc.data();
        const li = document.createElement("li");
        li.innerHTML = `
          <strong>${order.buyerName}</strong> ‚Äî ${order.buyerEmail}<br>
          Reference: ${order.reference}<br>
          Total: ‚Ç¶${order.totalAmount.toLocaleString()}<br>
          Status: <span class="order-status">${order.status}</span><br>
          Placed on: ${new Date(order.createdAt).toLocaleString()}<br>
          <button class="btn-sm btn-ship" data-order="${orderDoc.id}">Mark as Shipped</button>
          <hr><br>
        `;
        ordersList.appendChild(li);
      });
    });

    // Handle approve/reject actions
    document.addEventListener("click", async (e) => {
      if (e.target.tagName === "BUTTON" && e.target.dataset.id) {
        const ref = doc(db, e.target.dataset.type === "freelancer" ? "freelancer_applications" : "design_requests", e.target.dataset.id);
        await updateDoc(ref, { status: e.target.dataset.action });
        alert(`Marked as ${e.target.dataset.action}`);
        location.reload();
      }

      if (e.target.matches(".btn-ship")) {
        const orderId = e.target.dataset.order;
        const orderRef = doc(db, "orders", orderId);
        await updateDoc(orderRef, { status: "Shipped" });
        alert("‚úÖ Order marked as Shipped");
        location.reload();
      }
    });

    // Handle assignment
    document.addEventListener("change", async (e) => {
      if (e.target.classList.contains("assign-dropdown")) {
        const [freelancerId, freelancerName] = e.target.value.split("|");
        const requestId = e.target.dataset.id;
        if (!freelancerId) return;

        const requestRef = doc(db, "design_requests", requestId);
        await updateDoc(requestRef, {
          assignedTo: freelancerId,
          assignedName: freelancerName
        });

        alert(`Assigned to ${freelancerName}`);
        location.reload();
      }
    });

    // ‚úÖ Product posting (uses serverTimestamp)
    document.getElementById("productForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("prodName").value.trim();
      const category = document.getElementById("prodCategory").value.trim();
      const price = parseFloat(document.getElementById("prodPrice").value);
      const description = document.getElementById("prodDescription").value.trim();
      const imageUrl = document.getElementById("prodImage").value.trim();

      if (!name || !category || !price || !description || !imageUrl) {
        return alert("Please fill in all fields");
      }

      try {
        await addDoc(collection(db, "products"), {
          name,
          category,
          price,
          description,
          imageUrl,
          createdAt: serverTimestamp(), // ‚úÖ FIXED
          approved: true
        });

        document.getElementById("prodMsg").textContent = "‚úÖ Product added successfully!";
        e.target.reset();
      } catch (err) {
        console.error("Error adding product:", err);
        alert("‚ùå Failed to add product");
      }
    });
  </script>
</body>
</html>
